<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>ColorPal!</title>
<meta name="Generator" content="Vim/7.3">
<meta name="plugin-version" content="vim7.3_v10">
<meta name="syntax" content="html">
<meta name="settings" content="use_css,pre_wrap,expand_tabs">
<link href="http://fonts.googleapis.com/css?family=Titan+One" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Ovo'       rel='stylesheet' type='text/css'>
<link href="css/960_24_col.css" rel="stylesheet" type="text/css">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #d7d7d7; }
body { font-family: Verdana, sans-serif; cursive; color: #fff; background-color: #000; }
h1 {
    font-family : 'Titan One';
    font-weight : 400;
}
p.instructions {
    font-family: Ovo;
    font-size: 1.3em;
}
h1 {
    font-size   : 3em;
}
p.drop_message {
    font-size   : 2em;
}
p.credits {
}
img.logo {
    float: left;
}

[draggable] {
    -webkit-user-selectable: none;
     -khtml-user-selectable: none;
       -moz-user-selectable: none;
         -o-user-selectable: none;
            user-selectable: none;
}

.container {
    margin-top: 20px;
}

#colorpal_canvas { 

    outline: 6px solid #999;
    border: 1px solid #000;

    margin: 24px;

    -webkit-transition: all 0.33s ease-in; /* Safari and Chrome */
       -moz-transition: all 0.33s ease-in; /* Firefox 4 */
         -o-transition: all 0.33s ease-in; /* Opera */
            transition: all 0.33s ease-in;
}

#colorpal_input_image {
    display: none;
}

.swatches {
    line-height : 0;
    height      : 0;
    position    : relative;

    -webkit-transition : all ease 0.33s;
       -moz-transition : all ease 0.33s;
         -o-transition : all ease 0.33s;
            transition : all ease 0.33s;

    -webkit-border-radius: 6px;
       -moz-border-radius: 6px;
         -o-border-radius: 6px;
            border-radius: 6px;
}

.swatch {
    display : block;
    float   : left;
    width   : 50px;
    height  : 50px;
    margin  : 8px;
    border  : 1px solid black;

    -webkit-box-shadow : 0px 0px 9px 0px rgba( 0, 0, 0, 0.8 );
       -moz-box-shadow : 0px 0px 9px 0px rgba( 0, 0, 0, 0.8 );
         -o-box-shadow : 0px 0px 9px 0px rgba( 0, 0, 0, 0.8 );
            box-shadow : 0px 0px 9px 0px rgba( 0, 0, 0, 0.8 );

    -webkit-border-radius: 3px;
       -moz-border-radius: 3px;
         -o-border-radius: 3px;
            border-radius: 3px;
}
-->
</style>

<script type="text/javascript" src="median-cut.js/median-cut.js"> </script>
<script type="text/javascript" src="imagedata_to_rgb.js"> </script>
<script type="text/javascript">

var ctx,
    ctx_small,
    canvas,
    canvas_small,
    mc,
    img_width  = 0,
    img_height = 0,
    canvas_width  = 400,
    canvas_height = 400,
    canvas_small_height = 128,
    canvas_small_width = 128;

// Creates a swatch element with a given number and color
// Swatches have IDs "swatch1", "swatch2", etc.
// Clicking a swatch sets the body's bg color to the swatch's bg color
function create_swatch( _num, _color ) {
    var swatch = document.createElement("span");
    swatch.setAttribute( "id", "swatch" + _num );
    swatch.setAttribute( "class", "swatch" );
    swatch.onclick = function() { document.getElementById("colorpal_canvas").style.outline = "6px solid " + this.style.backgroundColor; };
    swatch.style.backgroundColor = "rgb(" + parseInt(_color[0]) + "," + parseInt(_color[1]) + "," + parseInt(_color[2]) + ")";
    return swatch;
}

function handle_file_select( evt ) {

    if( evt.stopPropagation ) evt.stopPropagation();
    if( evt.preventDefault  ) evt.preventDefault();

    var files = evt.dataTransfer.files; // FileList object

    // Loop through the FileList and render image files as thumbnails.
    for ( var i = 0, f; f = files[i]; i++ ) {

        // Only process image files.
        if (!f.type.match('image.*')) {
            continue;
        }

        var reader       = new FileReader();
        var img          = document.createElement("img"); // display-size image
        var img_small    = document.createElement("img"); // smaller image for faster median cut
        var swatches     = document.getElementById("swatches");
        var drop_message = document.getElementById("drop_message");

        img.onload = function() {

            var img_ratio     = img.width / img.height;
            var canvas_height = 400;
            var canvas_width  = 400;

            /*
            if( img_ratio > 1 ) { 
                // width > height
                if( img.width > canvas_width ) {
                    canvas_height = img.height
                }
            } else {
                // height > width
            }
            */
            canvas_width  = ( img.width  > canvas_width  ) ? ( img_ratio > 1 ) ? canvas_width  : canvas_width*img_ratio  : img.width;
            canvas_height = ( img.height > canvas_height ) ? ( img_ratio < 1 ) ? canvas_height : canvas_height/img_ratio : img.height;
            // Resize the canvas to the image size
            canvas.width             = canvas_width;
            canvas.height            = canvas_height;

            // Resize the canvas with CSS to trigger CSS3 transitions
            canvas.style.width       = canvas_width + "px";
            canvas.style.height      = canvas_height + "px";

            // Draw the downsized image inside the canvas
            ctx_small.drawImage( img, 0, 0, canvas_small_width, canvas_small_height );

            var data = ctx_small.getImageData( 0, 0, canvas_small_width, canvas_small_height );
            var rgbdata = imagedata_to_rgb( data );
            mc = MedianCut();
            mc.init( rgbdata );
            var palette = mc.get_fixed_size_palette( 8 );

            // clear any previous swatches
            swatches.innerHTML = "";

            for( var ic = palette.length - 1; ic >= 0; ic-- ) {
                var color = palette[ic];
                var sp = create_swatch( ic, color );
                swatches.appendChild( sp );
            }

            swatches.style.height = "66px";

            // Draw the display image
            ctx.drawImage(       img, 0, 0, canvas_width, canvas_height );

        };

        // Read in the image file as a data URL.
        reader.readAsDataURL(f);

        reader.onload = function(e) {

            // Assign the image's src to the filesystem image's data URL [http://en.wikipedia.org/wiki/Data_URI_scheme]
            img.src = e.target.result; 

        };
    }
}


// Drag and drop event handlers
function file_drag_start( e ) {

    if( e.stopPropagation ) {
        e.stopPropagation()
    }

    return false;
}

function file_drag_enter( e ) {
}

function file_drag_over ( e ) {
    e.stopPropagation();
    e.preventDefault();
    e.dataTransfer.dropEffect="copy";
    canvas.style.outline = "6px solid #fff";
}

function file_drag_leave( e ) {
    e.stopPropagation();
    e.preventDefault();
    e.dataTransfer.dropEffect="copy";
    canvas.style.outline = "6px solid #999";
}

function file_drop      ( e ) {

    console.log("file drop");
    
    e.stopPropagation();
    e.preventDefault();

    var files = e.dataTransfer.files;
    for( var i = 0, f; f = files[i]; i++ ) {
        console.log( f );
    }

}

function file_drag_end  ( e ) {
}





window.onload = function() {
    document.getElementById("colorpal_input_image").onchange = handle_file_select;

    canvas              = document.getElementById("colorpal_canvas");

    canvas_small        = document.createElement("canvas");
    canvas_small.width  = canvas_small_width;
    canvas_small.height = canvas_small_height;

    ctx                 = canvas.getContext("2d");
    ctx_small           = canvas_small.getContext("2d");

    // Set up drag handles
    var file_input = document.getElementById("colorpal_canvas");
    file_input.addEventListener( "dragstart", file_drag_start   , false );
    file_input.addEventListener( "dragenter", file_drag_enter   , false );
    file_input.addEventListener( "dragover" , file_drag_over    , false );
    file_input.addEventListener( "dragleave", file_drag_leave   , false );
    file_input.addEventListener( "drop"     , handle_file_select, false );
    file_input.addEventListener( "dragend"  , file_drag_end     , false );


};



</script>

</head>
<body>

<div class="container_24 container">

    <img class="grid_3" src="images/logo.png" alt="ColorPal logo" />
    <h1 class="grid_11">ColorPal!</h1>
    <p class="grid_10 instructions">
        Want to generate a color palette from an image?  
        <br />
        Drag and drop it in the box below. :)
    </p>

    <div class="clear"></div>

    <input type="file" id="colorpal_input_image"></input>

    <div id="list"></div>


    <div class="swatches" id="swatches"></div>

    <div class="clear"></div>

    <canvas id="colorpal_canvas" class="grid_16"></canvas>

    <p class="credits grid_24"><a href="http://mwcz.org">Author</a>  <a href="https://github.com/mwcz/ColorPal">Code</a>  <a href="https://twitter.com/mwcz">Twitter</a></p>

</div> <!-- /.container_24 -->

</body>
</html>

